name: Update Formula

on:
  repository_dispatch:
    types: [update-formula]

jobs:
  update-formula:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Wait for PyPI release
        id: wait
        run: |
          VERSION="${{ github.event.client_payload.version }}"
          echo "Waiting for PyPI release of version ${VERSION}..."

          # Wait up to 10 minutes for the release to appear on PyPI
          MAX_ATTEMPTS=60
          SLEEP_TIME=10

          for i in $(seq 1 "$MAX_ATTEMPTS"); do
            echo "Attempt ${i}/${MAX_ATTEMPTS}: Checking PyPI..."

            # Check if version exists
            RELEASES=$(curl -s https://pypi.org/pypi/uniqseq/json | jq -r '.releases | keys[]')

            if echo "$RELEASES" | grep -q "^${VERSION}$"; then
              echo "✅ Version ${VERSION} found on PyPI!"
              echo "release_found=true" >> "$GITHUB_OUTPUT"
              break
            fi

            if [ "$i" -eq "$MAX_ATTEMPTS" ]; then
              echo "❌ Timeout: Version ${VERSION} not found on PyPI after ${MAX_ATTEMPTS} attempts"
              echo "release_found=false" >> "$GITHUB_OUTPUT"
              exit 1
            fi

            echo "Version not yet available, waiting ${SLEEP_TIME}s..."
            sleep "$SLEEP_TIME"
          done

      - name: Get package info from PyPI
        id: pypi
        if: steps.wait.outputs.release_found == 'true'
        run: |
          VERSION="${{ github.event.client_payload.version }}"
          echo "Fetching package info for version ${VERSION}"

          # Get source distribution info
          INFO=$(curl -s https://pypi.org/pypi/uniqseq/json | jq -r ".releases[\"${VERSION}\"][] | select(.packagetype==\"sdist\")")
          URL=$(echo "$INFO" | jq -r '.url')
          SHA256=$(echo "$INFO" | jq -r '.digests.sha256')

          if [ -z "$URL" ] || [ -z "$SHA256" ]; then
            echo "❌ Error: Could not fetch package info from PyPI"
            exit 1
          fi

          echo "url=${URL}" >> "$GITHUB_OUTPUT"
          echo "sha256=${SHA256}" >> "$GITHUB_OUTPUT"
          echo "✅ Package URL: ${URL}"
          echo "✅ SHA256: ${SHA256}"

      - name: Update formula
        run: |
          VERSION="${{ github.event.client_payload.version }}"
          URL="${{ steps.pypi.outputs.url }}"
          SHA256="${{ steps.pypi.outputs.sha256 }}"

          # Update main package URL and SHA256
          sed -i "s|url \"https://files.pythonhosted.org/packages/.*/uniqseq-.*\.tar\.gz\"|url \"${URL}\"|" Formula/uniqseq.rb

          # Find the sha256 line that follows the uniqseq url and update it
          awk -v url="${URL}" -v sha="${SHA256}" '
            /url "https:.*uniqseq-/ { print; getline; sub(/sha256 ".*"/, "sha256 \"" sha "\""); print; next }
            {print}
          ' Formula/uniqseq.rb > Formula/uniqseq.rb.tmp
          mv Formula/uniqseq.rb.tmp Formula/uniqseq.rb

          # Update version in test
          sed -i "s/assert_match \"uniqseq version .*/assert_match \"uniqseq version $VERSION\", output/" Formula/uniqseq.rb

          echo "✅ Formula updated"

      - name: Verify changes
        run: |
          echo "=== Changes to Formula/uniqseq.rb ==="
          git diff Formula/uniqseq.rb

      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore: Update uniqseq to v${{ github.event.client_payload.version }}"
          title: "Update uniqseq to v${{ github.event.client_payload.version }}"
          body: |
            Automatically generated PR to update uniqseq formula.

            **Version:** ${{ github.event.client_payload.version }}
            **PyPI Release:** https://pypi.org/project/uniqseq/${{ github.event.client_payload.version }}/

            ### Changes
            - Updated source URL and SHA256 hash
            - Updated version test assertion

            ### Testing Checklist
            - [ ] Verify SHA256 hash matches PyPI
            - [ ] Test local installation: `brew install --build-from-source jeffreyurban/uniqseq/uniqseq`
            - [ ] Run tests: `brew test uniqseq`
            - [ ] Verify version: `uniqseq --version`

            ---
            *This PR was automatically created by the update-formula workflow triggered from the main uniqseq repository.*
          branch: update-v${{ github.event.client_payload.version }}
          delete-branch: true
          labels: |
            automated
            version-update
